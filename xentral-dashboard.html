<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Artikelverkauf ‚Äî Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0C0F14;
    --surface: #151920;
    --surface-2: #1C222B;
    --border: #252C38;
    --text: #E8ECF2;
    --text-dim: #7A8599;
    --accent: #4ADE80;
    --accent-dim: rgba(74, 222, 128, 0.12);
    --red: #F87171;
    --amber: #FBBF24;
    --radius: 10px;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
  .app { max-width: 1400px; margin: 0 auto; padding: 32px 24px; }

  .header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 32px; flex-wrap: wrap; gap: 16px; }
  .header h1 { font-size: 28px; font-weight: 700; letter-spacing: -0.5px; }
  .header h1 span { color: var(--accent); }
  .header-sub { color: var(--text-dim); font-size: 14px; margin-top: 4px; }

  .upload-zone { border: 2px dashed var(--border); border-radius: var(--radius); padding: 48px 24px; text-align: center; cursor: pointer; transition: all 0.3s ease; background: var(--surface); margin-bottom: 32px; }
  .upload-zone:hover, .upload-zone.dragover { border-color: var(--accent); background: var(--accent-dim); }
  .upload-zone input { display: none; }
  .upload-icon { font-size: 40px; margin-bottom: 12px; opacity: 0.6; }
  .upload-title { font-size: 16px; font-weight: 600; margin-bottom: 6px; }
  .upload-hint { color: var(--text-dim); font-size: 13px; }
  .upload-hint code { font-family: 'JetBrains Mono', monospace; background: var(--surface-2); padding: 2px 6px; border-radius: 4px; font-size: 12px; }

  .kpi-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 28px; }
  .kpi { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; transition: transform 0.2s; }
  .kpi:hover { transform: translateY(-2px); }
  .kpi-label { font-size: 12px; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text-dim); margin-bottom: 8px; font-weight: 500; }
  .kpi-value { font-family: 'JetBrains Mono', monospace; font-size: 28px; font-weight: 700; }
  .kpi-value.green { color: var(--accent); }
  .kpi-value.amber { color: var(--amber); }
  .kpi-value.red { color: var(--red); }

  .controls { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
  .search-box { flex: 1; min-width: 240px; position: relative; }
  .search-box input { width: 100%; padding: 10px 14px 10px 38px; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 14px; outline: none; transition: border-color 0.2s; }
  .search-box input:focus { border-color: var(--accent); }
  .search-box::before { content: '‚åï'; position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-dim); font-size: 18px; }
  select { padding: 10px 14px; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 14px; outline: none; cursor: pointer; min-width: 160px; }
  select:focus { border-color: var(--accent); }
  .btn { padding: 10px 18px; border: 1px solid var(--border); border-radius: var(--radius); background: var(--surface); color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 14px; cursor: pointer; font-weight: 500; transition: all 0.2s; }
  .btn:hover { background: var(--surface-2); border-color: var(--accent); }

  .table-wrap { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
  .table-scroll { overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; font-size: 14px; }
  thead th { padding: 14px 16px; text-align: left; font-weight: 600; font-size: 12px; text-transform: uppercase; letter-spacing: 0.6px; color: var(--text-dim); background: var(--surface-2); border-bottom: 1px solid var(--border); cursor: pointer; user-select: none; white-space: nowrap; transition: color 0.2s; }
  thead th:hover { color: var(--accent); }
  thead th.sorted { color: var(--accent); }
  thead th .sort-arrow { margin-left: 4px; opacity: 0.4; font-size: 10px; }
  thead th.sorted .sort-arrow { opacity: 1; }
  tbody tr { border-bottom: 1px solid var(--border); transition: background 0.15s; }
  tbody tr:last-child { border-bottom: none; }
  tbody tr:hover { background: rgba(74, 222, 128, 0.04); }
  td { padding: 12px 16px; white-space: nowrap; }
  td.num { font-family: 'JetBrains Mono', monospace; text-align: right; font-size: 13px; }
  td.artikelname { max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .badge { display: inline-block; padding: 3px 8px; border-radius: 6px; font-size: 12px; font-weight: 500; }
  .badge-cat { background: var(--accent-dim); color: var(--accent); }
  tfoot td { padding: 14px 16px; font-weight: 700; background: var(--surface-2); border-top: 2px solid var(--border); }

  .pagination { display: flex; justify-content: space-between; align-items: center; padding: 14px 16px; border-top: 1px solid var(--border); font-size: 13px; color: var(--text-dim); }
  .pagination button { padding: 6px 14px; background: var(--surface-2); border: 1px solid var(--border); border-radius: 6px; color: var(--text); cursor: pointer; font-family: 'DM Sans', sans-serif; font-size: 13px; transition: all 0.2s; }
  .pagination button:hover:not(:disabled) { border-color: var(--accent); }
  .pagination button:disabled { opacity: 0.3; cursor: not-allowed; }
  .page-btns { display: flex; gap: 6px; }

  .dashboard { display: none; }
  .dashboard.show { display: block; }

  @keyframes fadeUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
  .animate-in { animation: fadeUp 0.4s ease forwards; }
  .animate-in:nth-child(2) { animation-delay: 0.05s; }
  .animate-in:nth-child(3) { animation-delay: 0.1s; }

  @media (max-width: 768px) { .app { padding: 16px 12px; } .header h1 { font-size: 22px; } .kpi-value { font-size: 22px; } .controls { flex-direction: column; } .search-box { min-width: 100%; } }
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div>
      <h1>Artikel<span>verkauf</span></h1>
      <div class="header-sub" id="dateRange">CSV-Export aus Xentral hochladen</div>
    </div>
  </div>

  <div class="upload-zone" id="uploadZone">
    <input type="file" id="fileInput" accept=".csv,.tsv,.txt">
    <div class="upload-icon">üìÑ</div>
    <div class="upload-title">CSV aus Xentral hierher ziehen</div>
    <div class="upload-hint">Erwartet: <code>monat</code> <code>artikelnummer</code> <code>artikelname</code> <code>kategorie</code> <code>menge</code></div>
  </div>

  <div class="dashboard" id="dashboard">
    <div class="kpi-row">
      <div class="kpi animate-in">
        <div class="kpi-label">Gesamtmenge</div>
        <div class="kpi-value green" id="kpiMenge">‚Äî</div>
      </div>
      <div class="kpi animate-in">
        <div class="kpi-label">Artikel</div>
        <div class="kpi-value amber" id="kpiArtikel">‚Äî</div>
      </div>
      <div class="kpi animate-in">
        <div class="kpi-label">Kategorien</div>
        <div class="kpi-value red" id="kpiKat">‚Äî</div>
      </div>
    </div>

    <div class="controls">
      <div class="search-box"><input type="text" id="searchInput" placeholder="Artikelnummer oder Name suchen‚Ä¶"></div>
      <select id="filterKat"><option value="">Alle Kategorien</option></select>
      <select id="filterMonat"><option value="">Alle Monate</option></select>
      <button class="btn" id="btnExport">‚Üì CSV Export</button>
    </div>

    <div class="table-wrap">
      <div class="table-scroll">
        <table>
          <thead><tr id="tableHead"></tr></thead>
          <tbody id="tableBody"></tbody>
          <tfoot id="tableFoot"></tfoot>
        </table>
      </div>
      <div class="pagination">
        <span id="pageInfo"></span>
        <div class="page-btns">
          <button id="prevBtn" disabled>‚Üê Zur√ºck</button>
          <button id="nextBtn" disabled>Weiter ‚Üí</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const ROWS_PER_PAGE = 50;
const EXCLUDED = ['1000002', '1000003', '1000005'];
let allData = [], filtered = [], sortCol = 4, sortAsc = false, page = 0;

const columns = [
  { key: 'monat', label: 'Monat', type: 'text' },
  { key: 'artikelnummer', label: 'Artikelnr.', type: 'text' },
  { key: 'artikelname', label: 'Artikelname', type: 'text' },
  { key: 'kategorie', label: 'Kategorie', type: 'badge' },
  { key: 'menge', label: 'Menge', type: 'num' },
];

const uploadZone = document.getElementById('uploadZone');
const fileInput = document.getElementById('fileInput');
uploadZone.addEventListener('click', () => fileInput.click());
uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.classList.add('dragover'); });
uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
uploadZone.addEventListener('drop', e => { e.preventDefault(); uploadZone.classList.remove('dragover'); if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]); });
fileInput.addEventListener('change', e => { if (e.target.files.length) handleFile(e.target.files[0]); });

function handleFile(file) {
  const reader = new FileReader();
  reader.onload = e => { parseCSV(e.target.result); uploadZone.style.display = 'none'; document.getElementById('dashboard').classList.add('show'); };
  reader.readAsText(file, 'UTF-8');
}

function parseCSV(text) {
  const firstLine = text.split('\n')[0];
  const delim = firstLine.includes('\t') ? '\t' : firstLine.includes(';') ? ';' : ',';
  const lines = text.trim().split('\n');
  const headers = lines[0].split(delim).map(h => h.trim().toLowerCase().replace(/['"]/g, '').replace(/\s+/g, '_'));

  const headerMap = {};
  headers.forEach((h, i) => {
    if (h.includes('monat') || h.includes('month')) headerMap['monat'] = i;
    if (h.includes('artikelnummer') || h.includes('sku') || h === 'product_number') headerMap['artikelnummer'] = i;
    if (h.includes('artikelname') || h.includes('bezeichnung') || h.includes('designation')) headerMap['artikelname'] = headerMap['artikelname'] || i;
    if (h.includes('kateg') || h.includes('category')) headerMap['kategorie'] = i;
    if (h === 'menge' || h === 'quantity' || h === 'menge_gesamt') headerMap['menge'] = i;
  });

  allData = [];
  for (let i = 1; i < lines.length; i++) {
    const vals = lines[i].split(delim).map(v => v.trim().replace(/^['"]|['"]$/g, ''));
    if (vals.length < 3) continue;
    const row = {};
    for (const col of columns) {
      const idx = headerMap[col.key];
      let val = idx !== undefined ? vals[idx] || '' : '';
      if (col.type === 'num') val = parseFloat(val.replace(/\./g, '').replace(',', '.')) || 0;
      row[col.key] = val;
    }
    if (EXCLUDED.includes(row.artikelnummer)) continue;
    if (row.artikelnummer || row.artikelname) allData.push(row);
  }
  initDashboard();
}

function initDashboard() {
  const kats = [...new Set(allData.map(r => r.kategorie))].filter(Boolean).sort();
  const monate = [...new Set(allData.map(r => r.monat))].filter(Boolean).sort();
  document.getElementById('filterKat').innerHTML = '<option value="">Alle Kategorien</option>' + kats.map(k => `<option value="${k}">${k}</option>`).join('');
  document.getElementById('filterMonat').innerHTML = '<option value="">Alle Monate</option>' + monate.map(m => `<option value="${m}">${m}</option>`).join('');
  if (monate.length) document.getElementById('dateRange').textContent = `Zeitraum: ${monate[0]} ‚Äî ${monate[monate.length - 1]} ¬∑ ${allData.length} Zeilen`;
  document.getElementById('searchInput').addEventListener('input', () => { page = 0; render(); });
  document.getElementById('filterKat').addEventListener('change', () => { page = 0; render(); });
  document.getElementById('filterMonat').addEventListener('change', () => { page = 0; render(); });
  document.getElementById('prevBtn').addEventListener('click', () => { page--; render(); });
  document.getElementById('nextBtn').addEventListener('click', () => { page++; render(); });
  document.getElementById('btnExport').addEventListener('click', exportCSV);
  render();
}

function applyFilters() {
  const search = document.getElementById('searchInput').value.toLowerCase();
  const kat = document.getElementById('filterKat').value;
  const monat = document.getElementById('filterMonat').value;
  filtered = allData.filter(r => {
    if (search && !r.artikelnummer.toLowerCase().includes(search) && !r.artikelname.toLowerCase().includes(search)) return false;
    if (kat && r.kategorie !== kat) return false;
    if (monat && r.monat !== monat) return false;
    return true;
  });
  const col = columns[sortCol];
  filtered.sort((a, b) => {
    let va = a[col.key], vb = b[col.key];
    if (col.type === 'num') return sortAsc ? va - vb : vb - va;
    return sortAsc ? String(va).localeCompare(String(vb)) : String(vb).localeCompare(String(va));
  });
}

function render() {
  applyFilters();
  const totalMenge = filtered.reduce((s, r) => s + (r.menge || 0), 0);
  document.getElementById('kpiMenge').textContent = totalMenge.toLocaleString('de-DE');
  document.getElementById('kpiArtikel').textContent = new Set(filtered.map(r => r.artikelnummer)).size.toLocaleString('de-DE');
  document.getElementById('kpiKat').textContent = new Set(filtered.map(r => r.kategorie)).size;

  document.getElementById('tableHead').innerHTML = columns.map((c, i) =>
    `<th class="${i === sortCol ? 'sorted' : ''}" onclick="sortBy(${i})">${c.label}<span class="sort-arrow">${i === sortCol ? (sortAsc ? '‚ñ≤' : '‚ñº') : '‚Üï'}</span></th>`
  ).join('');

  const start = page * ROWS_PER_PAGE;
  const pageData = filtered.slice(start, start + ROWS_PER_PAGE);
  document.getElementById('tableBody').innerHTML = pageData.map(r => `<tr>
    <td>${r.monat}</td>
    <td><span style="font-family:'JetBrains Mono',monospace;font-size:13px">${r.artikelnummer}</span></td>
    <td class="artikelname" title="${r.artikelname}">${r.artikelname}</td>
    <td><span class="badge badge-cat">${r.kategorie}</span></td>
    <td class="num">${(r.menge || 0).toLocaleString('de-DE')}</td>
  </tr>`).join('');

  document.getElementById('tableFoot').innerHTML = `<tr>
    <td colspan="4" style="text-align:right;color:var(--text-dim)">Gesamt (${filtered.length} Zeilen)</td>
    <td class="num" style="color:var(--accent)">${totalMenge.toLocaleString('de-DE')}</td>
  </tr>`;

  const totalPages = Math.ceil(filtered.length / ROWS_PER_PAGE);
  document.getElementById('pageInfo').textContent = `Seite ${page + 1} von ${totalPages || 1} ¬∑ ${filtered.length} Ergebnisse`;
  document.getElementById('prevBtn').disabled = page === 0;
  document.getElementById('nextBtn').disabled = page >= totalPages - 1;
}

function sortBy(colIdx) {
  if (sortCol === colIdx) sortAsc = !sortAsc; else { sortCol = colIdx; sortAsc = columns[colIdx].type === 'num' ? false : true; }
  page = 0; render();
}

function exportCSV() {
  const sep = ';';
  let csv = columns.map(c => c.label).join(sep) + '\n';
  filtered.forEach(r => { csv += columns.map(c => { let v = r[c.key]; if (c.type === 'num') v = String(v).replace('.', ','); return `"${v}"`; }).join(sep) + '\n'; });
  const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `artikelverkauf_${new Date().toISOString().slice(0,10)}.csv`; a.click();
}
</script>
</body>
</html>
